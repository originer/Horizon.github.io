<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/Horizon.github.io/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/Horizon.github.io/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/Horizon.github.io/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/Horizon.github.io/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/Horizon.github.io/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/Horizon.github.io/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/Horizon.github.io/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Horizon Notes">
<meta property="og:url" content="https://originer.github.io/Horizon.github.io/index.html">
<meta property="og:site_name" content="Horizon Notes">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Horizon Notes">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/Horizon.github.io/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://originer.github.io/Horizon.github.io/"/>





  <title>Horizon Notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/Horizon.github.io/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Horizon Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/Horizon.github.io/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/Horizon.github.io/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://originer.github.io/Horizon.github.io/Horizon.github.io/2018/05/01/设计模式：适配器模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Horizon">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/Horizon.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Horizon Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Horizon.github.io/2018/05/01/设计模式：适配器模式/" itemprop="url">Java设计模式：适配器模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-01T01:36:28+08:00">
                2018-05-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Horizon.github.io/categories/设计模式/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="适配器模式"><a href="#适配器模式" class="headerlink" title="适配器模式"></a>适配器模式</h3><p>　模式所涉及的角色有：</p>
<p>　　●　　<strong>目标(Target)角色：</strong>这就是所期待得到的接口。注意：由于这里讨论的是类适配器模式，因此目标不可以是类。</p>
<p>　　●　　<strong>源(Adapee)角色：</strong>现在需要适配的接口。</p>
<p>　　●　　<strong>适配器(Adaper)角色：</strong>适配器类是本模式的核心。适配器把源接口转换成目标接口。显然，这一角色不可以是接口，而必须是具体类。</p>
<p>适配器模式是一种常用的结构型模式，经常用于<strong>旧系统改造</strong>，<strong>IO流</strong>大量使用适配器模式；</p>
<p>适配器模式主要有两类： </p>
<ul>
<li>1、类适配 [使用继承]</li>
<li>2、组合 [使用内置对象]</li>
</ul>
<h4 id="类适配"><a href="#类适配" class="headerlink" title="类适配"></a>类适配</h4><p><img src="data:image/png;base64,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iMJTG4do13Vv3769wdJ+//33f/7zn0EQ/P3vf//vf/+79epcoNvb2+/fv6+02TxBhCg8tX2IYg03NzdBEFxfXz979uyXX37ZenWAB1SM7MBPaw/uEKIb+Pr167Nnz/797393XXd9fR0EwZ9//rn1SgFTGNlZG4M7q1pvcIcQ3cCrV6+ePXt2d3fXdd33799fvHjx/Plz+h6xc4zsrMQM7vzjH//43//+t/XqXKBVB3cI0XN7//59EAS3t7fmnaqqgiD47bffNlwrAFu5ubkJguDNmze0Az4iRM/q27dvz58/v7q6st6X7efLly+brBWArejBndevXz979uzr169brxSOQIie1S+//DIYliZc6dQFnhQ9uPPly5dnz569fv1665XCEQjR8/n06dNEd4108/7xxx9nXisAW3EHd3777beAMw29QoieiZxA9OLFi4ljTb1PCuCyDQ7u/PXXX8+fP3/58iWdUr4gRM9ELmX59OnTxDR3d3dmdATAZRsb3Hn79q11eIo9I0TPQYY65txU4Y8//lj1kiYAezA9uHN1dfXTTz99+/btzGuFExCi5zB/k/j+/fvV1dXz58/ZfoBL9eDgjlz29uuvv555xXACQnR1ctOpt2/fzpxebg3z5s2bVdcKwFbmDO68fv2ay968QIiu69u3b8+ePXv16tVRn/r111+DIKiqap2VArCZmYM70nT8/PPP51krnIwQXddpV09///6dM/SAizR/cEfuZMTlLjtHiK7ow4cPQRDc3Nyc8Nk///zz5M8C2KejBndkZ5oba+8cIbqWx1/vJUexDIoAl+GEwZ3H7IjjPAjRtci45s3NzcmPwZPth0ER4DKcNrjz888/P3v2jNP1d4sQXcW3b98WfBLe58+ft/5CAB7l5GPKL1++BEHADXV3ixBdy/v37x98yl0QBP/5z3+mp3n79i0jIoDXHjm4I91a7EzvEyG6pSAIuFMucPEeObgjR7HuIxSxB4TolghR4OItOLjDwegOEaJbIkSBp2Dm4A4jOz4iRLdEiAIQQUBr7CV+ti0RogAEIeopfrYtEaIABCHqKX62Lb169YprqAF0hKi3+NkAYHuEqKf42QBge4Sop/jZAGB7hKin+Nm2VFUVF34B6AhRb/GzbYmzcwEIQtRT/GxbIkQBCELUU/xsWyJEAQhC1FP8bFsiRAEIQtRT/GxbIkQB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" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 被适配的对象</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Adaptee</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Adaptee request"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 适配器</span></div><div class="line"><span class="comment"> * 把被适配对象与target联系起来</span></div><div class="line"><span class="comment"> * 1、类适配 [使用继承]</span></div><div class="line"><span class="comment"> * 2、组合 [使用内置对象]</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> <span class="keyword">extends</span> <span class="title">Adaptee</span> <span class="keyword">implements</span> <span class="title">Target</span></span>&#123;</div><div class="line">    <span class="comment">//使用继承//   </span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReq</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.request();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(Target t)</span> </span>&#123;</div><div class="line">        t.handleReq();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Client c = <span class="keyword">new</span> Client();</div><div class="line">        c.test(<span class="keyword">new</span> Adapter());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="组合"><a href="#组合" class="headerlink" title="组合"></a>组合</h4><p><img src="data:image/png;base64,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5KuEg1Q9ymd/2sjzgXcfQZqLXlQMMkCwbdvTp7YbB+9uzvnewne7Smjc1Fs43gXYCZLu5lzlLfyljbjPVeCK4F2AnSDpbg5RCkcE7wLsBEl3c4hSOCJH9e7d3V0DcCju7++RxLY0eBcOyM7pdgPvfv78OYIX47/+67+uHYST8/PPPz//KQAB78IROZ53x3H88ccfP8LW/POf//zTn/4URdEf/vCH//3f/712cM7J/f39t2/fNnkKYMS7cEwO6V14CaQW9MOHD69evfrb3/527eAAPE5DqxMckJ2bnPBuoHz9+vWHH354+/btOI53d3dRFP373/++dqAAHoFWJzguuzU54d1A+fvf/x5FUdM04zh++/bt9evXP/zwAzWiED60Or0E//jHP16/fh1F0evXr//xj39cOzgnZM8mJ7wbIr/++msURe/fv9ctTdNEUfT3v//9iqECgKvw+++/v3v3TrKFX3/99d27d7///vu1AwVPB++GyLt37169evXlyxe78cOHD/LUXSlQAHAFVLrjOEZRNI4j6j06eDc4/v3vf0dRdHd352zXFl9qmwFuBCvd8cG7I+o9OHg3LJabcj99+hRF0b/+9a/9AwYAO+NIdzTeHVHvkcG7YfGvf/1ruVvdZBU0AJwMX7rj994dUe9hwbsB8fXr11evXsnYoTm+fPny6tWrv/71r7uFCgB2ZlK6o+fdEfUeE7wbEH/7298u6Tn1aJkYAI7LnHTHKe+OqPeA4N1QkEECHz58eHTPb9++vX379ocffvj69esOAQOAPXn//v3cy/ekd8dx/PXXX+2wQwgcvBsKb9++ffXq1YUqlVmBLpE0AJyGOe/CseBXDALpqHx/f3/5If/93/+tE1oBwC2Ad88Bv+L1+fbt2w8//PD69etVA3PlqDdv3jCcF+BGwLvngF/x+shUzE9Y9kBm2Pj48eMLBAoAggPvngN+xSvzzHFB79+/f/XqFZNHAtwCePcc8Ctemffv30vL7tOWjfz555+jKPrzn/987fsAgBcH754DfsVr8vXr161Wjvz8+fO17wYAXha8ew74Fa/Mp0+flleFjKLof/7nf5b3+fHHH+ldBXB68O454FcMnSiKmI0ZAEa8exb4FUMH7wKAgHfPAb9i6OBdABDw7jngVwwdvAsAAt49B/yKoYN3AUDAu+eAXzF08C4ACHj3HPArhs67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" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> <span class="keyword">implements</span> <span class="title">Target</span> </span>&#123;</div><div class="line">    <span class="comment">//     组合</span></div><div class="line">    <span class="keyword">private</span> Adaptee adaptee;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Adapter</span><span class="params">(Adaptee adaptee)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.adaptee = adaptee;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReq</span><span class="params">()</span> </span>&#123;</div><div class="line">        adaptee.request();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(Target t)</span> </span>&#123;</div><div class="line">        t.handleReq();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Client c = <span class="keyword">new</span> Client();</div><div class="line">        c.test(<span class="keyword">new</span> Adapter(<span class="keyword">new</span> Adaptee()));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://originer.github.io/Horizon.github.io/Horizon.github.io/2018/05/01/设计模式：命令模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Horizon">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/Horizon.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Horizon Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Horizon.github.io/2018/05/01/设计模式：命令模式/" itemprop="url">Java设计模式：命令模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-01T01:36:28+08:00">
                2018-05-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Horizon.github.io/categories/设计模式/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h1><p><strong>命令模式将“请求”封装成对象，命令模式是数据驱动设计模式，属于行为模式类别。 请求作为命令包装在一个对象下，并传递给调用器对象。 调用者对象查找可以处理此命令的适当对象，并将命令传递到执行命令的相应对象。</strong></p>
<p>下面以灯泡的开关控制为例子来学习命令模式：</p>
<p><em>先定义一个Light类</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Light</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">on</span><span class="params">()</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"light  on"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">off</span><span class="params">()</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"light  off"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>声明一个Command接口，所有的命令都要实现这个接口</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Command</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>实现一个控制灯泡开关的命令类，既然属于命令自然要实现Command接口</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LightOnCommand</span> <span class="keyword">implements</span> <span class="title">Command</span> </span>&#123;</div><div class="line">    Light light;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LightOnCommand</span><span class="params">(Light light)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.light = light;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</div><div class="line">        light.on();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>接下来定义一个Controller类，可以理解为灯泡的遥控器</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleRemoteController</span> </span>&#123;</div><div class="line">    Command solot;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCommand</span><span class="params">(Command solot)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.solot = solot;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pressWasPressed</span><span class="params">()</span> </span>&#123;</div><div class="line">        solot.execute();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>对SimpleRemoteController做简单的测试</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">       SimpleRemoteController remoteController = <span class="keyword">new</span> SimpleRemoteController();</div><div class="line">       Light light = <span class="keyword">new</span> Light();</div><div class="line">       LightOnCommand lightOnCommand = <span class="keyword">new</span> LightOnCommand(light);</div><div class="line"></div><div class="line">       remoteController.setCommand(lightOnCommand);</div><div class="line">       remoteController.pressWasPressed();</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p><strong>可以成功打印出 light on</strong></p>
<p>从上面的简单例子可以看出灯泡与遥控器通过命令来交互，这两个类互不相干，实现了解耦。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://originer.github.io/Horizon.github.io/Horizon.github.io/2018/05/01/设计模式：单例模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Horizon">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/Horizon.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Horizon Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Horizon.github.io/2018/05/01/设计模式：单例模式/" itemprop="url">Java设计模式：单例模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-01T01:36:28+08:00">
                2018-05-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Horizon.github.io/categories/设计模式/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>饿汉模式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sigleton</span> </span>&#123;</div><div class="line">    <span class="comment">//饿汉模式 outInstance是私有的</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Sigleton ourInstance = <span class="keyword">new</span> Sigleton();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 此实现是线程安全的  JVM在加载此类时，因为对于static属性的初始化只能由一个线程执行且仅执行一次</span></div><div class="line"><span class="comment">     * 缺点：instance在类装载时就实例化 这时候初始化instance显然没有达到lazy loading的效果</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Sigleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> ourInstance;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//把构造函数声明为private 客户对象无法创建该实例</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Sigleton</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>懒汉模式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sigleton2</span> </span>&#123;</div><div class="line">    <span class="comment">//懒汉模式（需要时才实例化对象）</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Sigleton2 instance;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 线程不安全 原因：getInstance在高并发环境下可能会被同时调用，导致if(instance==null)判断就不靠谱</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line"><span class="comment">//    public static Sigleton2 getInstance() &#123;</span></div><div class="line"><span class="comment">//        if (instance == null) &#123;</span></div><div class="line"><span class="comment">//            instance = new Sigleton2();</span></div><div class="line"><span class="comment">//        &#125;</span></div><div class="line"><span class="comment">//        return instance;</span></div><div class="line"><span class="comment">//    &#125;</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 解决方法：添加synchornized关键字</span></div><div class="line"><span class="comment">     * 缺点：性能降低</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Sigleton2 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">            instance = <span class="keyword">new</span> Sigleton2();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Sigleton2</span><span class="params">()</span></span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>双重校验锁</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DoubleCheckSingleton</span> </span>&#123;</div><div class="line">    <span class="comment">//此方法需要在Java 5及以上的版本才能运行  volatile关键字在Java5引入</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">static</span> DoubleCheckSingleton instance = <span class="keyword">null</span>;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">DoubleCheckSingleton</span><span class="params">()</span></span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DoubleCheckSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123; <span class="comment">//检查实例是否创建 如果没有把    DoubleCheckSingleton.class设置为同步</span></div><div class="line">            <span class="keyword">synchronized</span> (DoubleCheckSingleton.class) &#123;</div><div class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;  <span class="comment">//double check</span></div><div class="line">                    instance = <span class="keyword">new</span> DoubleCheckSingleton();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>静态内部类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticSingleton</span> </span>&#123;</div><div class="line"></div><div class="line">	 <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;</div><div class="line">	     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> StaticSingleton INSTANCE = <span class="keyword">new</span> StaticSingleton();</div><div class="line">     &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">StaticSingleton</span> <span class="params">()</span></span>&#123;&#125;</div><div class="line">    <span class="comment">//这种方式同样利用了classloder的机制来保证初始化instance时只有一个线程</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> StaticSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> SingletonHolder.INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>Singleton的序列化</strong></p>
<p>如果单例类实现了Serializable接口，默认情况下，每次反序列化总会创建一个新的实例对象。<br><strong>解决方法：重写readResolve（）方法，直接返回单例对象</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> Sigleton;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.Serializable;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created by Zz on 2017/5/3 0003.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sigleton</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUid = -<span class="number">6012841243252L</span>;</div><div class="line">    <span class="comment">//饿汉模式 outInstance是私有的</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Sigleton ourInstance = <span class="keyword">new</span> Sigleton();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 此实现是线程安全的  JVM在加载此类时，因为对于static属性的初始化只能由一个线程执行且仅执行一次</span></div><div class="line"><span class="comment">     * 缺点：instance在类装载时就实例化 这时候初始化instance显然没有达到lazy loading的效果</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Sigleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> ourInstance;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//把构造函数声明为private 客户对象无法创建该实例</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Sigleton</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">readResolve</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> ourInstance;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://originer.github.io/Horizon.github.io/Horizon.github.io/2018/05/01/redis问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Horizon">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/Horizon.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Horizon Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Horizon.github.io/2018/05/01/redis问题/" itemprop="url">记录一些Redis在分布式环境下的实践遇到的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-01T01:36:28+08:00">
                2018-05-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Horizon.github.io/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="利用redis实现分布式集群的单点登陆功能"><a href="#利用redis实现分布式集群的单点登陆功能" class="headerlink" title="利用redis实现分布式集群的单点登陆功能;"></a>利用redis实现分布式集群的单点登陆功能;</h3><p>session作为一般的登陆凭证，在集群环境下会遇到一些问题：</p>
<p>1、如果服务器分布在多个Tomcat服务器上，那么用户每次登陆都未必访问同一个服务器。</p>
<p>2、如果Tomcat服务器挂掉，用户也会受到影响。</p>
<p>所以就想出以下解决方案：使用一个Redis服务器用来解决用户的单点登陆问题。这样，无论用户被负载均衡到哪个Tomcat服务器都可以通过redis服务器验证身份；</p>
<p>但是又会产生一个新的问题，如果一个redis服务器不够用怎么办?</p>
<p>很自然的能够想到添加redis服务器的解决方案，但是在增加redis服务器时遇到 了一些疑惑，以下作为记录：</p>
<h3 id="ShardedJedis"><a href="#ShardedJedis" class="headerlink" title="ShardedJedis"></a>ShardedJedis</h3><p>ShardedJedis是通过<strong>一致性哈希</strong>来实现分布式缓存的，通过一定的策略把不同的key分配到不同的redis server上，达到横向扩展的目的；</p>
<p>ShardedJedis的使用方法除了配置时有点区别，其他和Jedis基本类似，有一点要注意的是 ShardedJedis<strong>不支持多命令操作，</strong>像mget、mset、brpop等可以在redis命令后一次性操作多个key的命令，具体包括哪些，大家可以看Jedis下的 <strong>MultiKeyCommands </strong>这个类，这里面就包含了所有的多命令操作。很贴心的是，Redis作者已经把这些命令从ShardedJedis过滤掉了;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> Zz</span></div><div class="line"><span class="comment"> **/</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisShardedPool</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ShardedJedisPool pool;<span class="comment">//sharded jedis连接池</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer maxTotal = Integer.parseInt(PropertiesUtil.getProperty(<span class="string">"redis.max.total"</span>, <span class="string">"20"</span>));    <span class="comment">//最大连接数</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer maxIdle = Integer.parseInt(PropertiesUtil.getProperty(<span class="string">"redis.max.idle"</span>, <span class="string">"10"</span>));</div><div class="line">    <span class="comment">//在jedispool中最大的idle状态的（空闲的）jedis实例个数</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer minIdle = Integer.parseInt(PropertiesUtil.getProperty(<span class="string">"redis.min.idle"</span>, <span class="string">"2"</span>));</div><div class="line">    <span class="comment">//在jedispool中最小的idle状态的（空闲的）jedis实例个数</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Boolean testOnBorrow = Boolean.parseBoolean(PropertiesUtil.getProperty(<span class="string">"redis.test.borrow"</span>, <span class="string">"true"</span>));</div><div class="line">    <span class="comment">//在borrow一个jedis实例的时候，是否要进行验证操作，如果赋值true，则得到的jedis实例是可用的</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Boolean testOnReturn = Boolean.parseBoolean(PropertiesUtil.getProperty(<span class="string">"redis.test.return"</span>, <span class="string">"true"</span>));</div><div class="line">    <span class="comment">//在return一个jedis实例的时候，是否要进行验证操作，如果赋值true，则返回成功</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String redis1Ip = PropertiesUtil.getProperty(<span class="string">"redis1.ip"</span>);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer redis1Port = Integer.parseInt(PropertiesUtil.getProperty(<span class="string">"redis1.port"</span>));</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String redis2Ip = PropertiesUtil.getProperty(<span class="string">"redis2.ip"</span>);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer redis2Port = Integer.parseInt(PropertiesUtil.getProperty(<span class="string">"redis2.port"</span>));</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initPool</span><span class="params">()</span> </span>&#123;</div><div class="line">        JedisPoolConfig config = <span class="keyword">new</span> JedisPoolConfig();</div><div class="line">        config.setMaxIdle(maxTotal);</div><div class="line">        config.setMaxIdle(maxIdle);</div><div class="line">        config.setMinIdle(minIdle);</div><div class="line"></div><div class="line">        config.setTestOnBorrow(testOnBorrow);</div><div class="line">        config.setTestOnReturn(testOnReturn);</div><div class="line"></div><div class="line">        config.setBlockWhenExhausted(<span class="keyword">true</span>);<span class="comment">//连接耗尽时是否阻塞，false会抛出异常，true阻塞直到超时</span></div><div class="line"></div><div class="line"><span class="comment">//        pool = new JedisPool(config, redisIp, redisPort, 1000 * 2);</span></div><div class="line">        JedisShardInfo info1 = <span class="keyword">new</span> JedisShardInfo(redis1Ip, redis1Port, <span class="number">1000</span> * <span class="number">2</span>);</div><div class="line">        JedisShardInfo info2 = <span class="keyword">new</span> JedisShardInfo(redis2Ip, redis2Port, <span class="number">1000</span> * <span class="number">2</span>);</div><div class="line"></div><div class="line">        List&lt;JedisShardInfo&gt; jedisShardInfos = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">2</span>);</div><div class="line"></div><div class="line">        jedisShardInfos.add(info1);</div><div class="line">        jedisShardInfos.add(info2);</div><div class="line"></div><div class="line">        pool = <span class="keyword">new</span> ShardedJedisPool(config, jedisShardInfos, Hashing.MURMUR_HASH, Sharded.DEFAULT_KEY_TAG_PATTERN);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//静态加载</span></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        initPool();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ShardedJedis <span class="title">getJedis</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> pool.getResource();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">returnResource</span><span class="params">(ShardedJedis jedis)</span> </span>&#123;</div><div class="line">        pool.returnResource(jedis);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">returnBrokeResource</span><span class="params">(ShardedJedis jedis)</span> </span>&#123;</div><div class="line">        pool.returnBrokenResource(jedis);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"></div><div class="line">        ShardedJedis shardedJedis = pool.getResource();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">            shardedJedis.set(<span class="string">"key"</span> + i, <span class="string">"value"</span> + i);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">            System.out.println(shardedJedis.get(<span class="string">"key"</span> + i));</div><div class="line">        &#125;</div><div class="line">        returnResource(shardedJedis);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="一致性哈希实现分布式缓存"><a href="#一致性哈希实现分布式缓存" class="headerlink" title="一致性哈希实现分布式缓存"></a>一致性哈希实现分布式缓存</h3><p>ShardedJedis通过一致性哈希实现的的分布式缓存。主要思路：</p>
<p>1、redis服务器节点划分：将每台服务器节点采用hash算法划分为160个虚拟节点(可以配置划分权重)，将划分虚拟节点采用TreeMap存储<br>2、对每个redis服务器的物理连接采用LinkedHashMap存储<br>3、对Key or KeyTag 采用同样的hash算法，然后从TreeMap获取大于等于键hash值得节点，取最邻近节点存储；当key的hash值大于虚拟节点hash值得最大值时，存入第一个虚拟节点</p>
<p>sharded采用的hash算法：MD5 和 MurmurHash两种；默认采用64位的MurmurHash算法；</p>
<p>我们追踪 shardedJedis.get() 进行分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">Jedis j = getShard(key);</div><div class="line"><span class="keyword">return</span> j.get(key);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">public</span> R <span class="title">getShard</span><span class="params">(String key)</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> resources.get(getShardInfo(key));</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">public</span> S <span class="title">getShardInfo</span><span class="params">(String key)</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> getShardInfo(SafeEncoder.encode(getKeyTag(key)));</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"><span class="comment">* 通过key 获取分片。对key 也使用algo hash 算法，从虚拟节点（nodes）中取键值大于等于key hash后的值。 </span></div><div class="line"><span class="comment">* 如果没有大于等于key hash后的值，那么取第一个node。 </span></div><div class="line"><span class="comment">* 如果有则取当前映射的第一个node </span></div><div class="line"><span class="comment">**/</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> S <span class="title">getShardInfo</span><span class="params">(<span class="keyword">byte</span>[] key)</span> </span>&#123;</div><div class="line">	SortedMap&lt;Long, S&gt; tail = nodes.tailMap(algo.hash(key));</div><div class="line">	<span class="keyword">if</span> (tail.isEmpty()) &#123;</div><div class="line">	    <span class="keyword">return</span> nodes.get(nodes.firstKey());</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> tail.get(tail.firstKey());</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://originer.github.io/Horizon.github.io/Horizon.github.io/2018/05/01/jdk代理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Horizon">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/Horizon.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Horizon Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Horizon.github.io/2018/05/01/jdk代理/" itemprop="url">JDK代理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-01T01:36:28+08:00">
                2018-05-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Horizon.github.io/categories/设计模式/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Java中代理的实现一般分为三种：JDK静态代理、JDK动态代理以及CGLIB动态代理。在Spring的AOP实现中，主要应用了JDK动态代理以及CGLIB动态代理。但是本文着重介绍JDK动态代理机制，CGLIB动态代理后面会接着探究。<br>代理一般实现的模式为JDK静态代理：创建一个接口，然后创建被代理的类实现该接口并且实现该接口中的抽象方法。之后再创建一个代理类，同时使其也实现这个接口。在代理类中持有一个被代理对象的引用，而后在代理类方法中调用该对象的方法。<br>其实就是代理类为被代理类预处理消息、过滤消息并在此之后将消息转发给被代理类，之后还能进行消息的后置处理。代理类和被代理类通常会存在关联关系(即上面提到的持有的被带离对象的引用)，代理类本身不实现服务，而是通过调用被代理类中的方法来提供服务。</p>
<h2 id="JDK一般代理"><a href="#JDK一般代理" class="headerlink" title="JDK一般代理"></a>JDK一般代理</h2><p>jdk一般代理比较简单，我们只需要 </p>
<ol>
<li>定义一个接口 A </li>
<li>定义实现接口的具体类 AImpl</li>
<li>定义 AImpl的代理类  ProxyImplA</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//接口</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Star</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">confer</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">signComtract</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sing</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">//接口的具体实现</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RealStar</span> <span class="keyword">implements</span> <span class="title">Star</span></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confer</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"RealStar confer"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">signComtract</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"RealStar signComtract"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sing</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"RealStar sing"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//代理类</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyStar</span> <span class="keyword">implements</span> <span class="title">Star</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Star star;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProxyStar</span><span class="params">(Star real)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.star = real;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confer</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"ProxyStar confer"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">signComtract</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"ProxyStar signComtract"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sing</span><span class="params">()</span> </span>&#123;</div><div class="line">        star.sing();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//测试</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Star real = <span class="keyword">new</span> RealStar();</div><div class="line">        Star proxy = <span class="keyword">new</span> ProxyStar(real);</div><div class="line">        proxy.sing();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">RealStar sing</div><div class="line">ProxyStar confer</div><div class="line">ProxyStar signComtract</div><div class="line"></div><div class="line">Process finished with exit code <span class="number">0</span></div></pre></td></tr></table></figure>
<p>这种方法一般称为JDK静态代理，比较简单，但是不实用。因为静态代理有一个很明显的缺点：由于代理只能为一个类服务，如果需要代理的类很多，那么就需要编写大量的代理类，比较繁琐。</p>
<h2 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h2><p>使用动态代理可以解决静态代理的缺点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 1.通过实现InvocationHandler接口来自定义自己的InvocationHandler;</span></div><div class="line"><span class="comment"> * &lt;p&gt;</span></div><div class="line"><span class="comment"> * 2.通过Proxy.getProxyClass获得动态代理类</span></div><div class="line"><span class="comment"> * &lt;p&gt;</span></div><div class="line"><span class="comment"> * 3.通过反射机制获得代理类的构造方法，方法签名为getConstructor(InvocationHandler.class)</span></div><div class="line"><span class="comment"> * &lt;p&gt;</span></div><div class="line"><span class="comment"> * 4.通过构造函数获得代理对象并将自定义的InvocationHandler实例对象传为参数传入</span></div><div class="line"><span class="comment"> * &lt;p&gt;</span></div><div class="line"><span class="comment"> * 5.通过代理对象调用目标方法</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProxy</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IHello</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> <span class="keyword">implements</span> <span class="title">IHello</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</div><div class="line">            System.out.println(<span class="string">"Hello world!!"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//自定义InvocationHandler</span></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HWInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</div><div class="line">        <span class="comment">//目标对象</span></div><div class="line">        <span class="keyword">private</span> Object target;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HWInvocationHandler</span><span class="params">(Object target)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.target = target;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            System.out.println(<span class="string">"------插入前置通知代码-------------"</span>);</div><div class="line">            <span class="comment">//执行相应的目标方法</span></div><div class="line">            Object rs = method.invoke(target, args);</div><div class="line">            System.out.println(<span class="string">"------插入后置处理代码-------------"</span>);</div><div class="line">            <span class="keyword">return</span> rs;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException </span>&#123;</div><div class="line"><span class="comment">//        //生成$Proxy0的class文件</span></div><div class="line"><span class="comment">//        System.getProperties().put("sun.misc.ProxyGenerator.saveGeneratedFiles", "true");</span></div><div class="line"><span class="comment">//        //获取动态代理类</span></div><div class="line"><span class="comment">//        Class proxyClazz = Proxy.getProxyClass(IHello.class.getClassLoader(), IHello.class);</span></div><div class="line"><span class="comment">//        //获得代理类的构造函数，并传入参数类型InvocationHandler.class</span></div><div class="line"><span class="comment">//        Constructor constructor = proxyClazz.getConstructor(InvocationHandler.class);</span></div><div class="line"><span class="comment">//        //通过构造函数来创建动态代理对象，将自定义的InvocationHandler实例传入</span></div><div class="line"><span class="comment">//        IHello iHello = (IHello) constructor.newInstance(new HWInvocationHandler(new Hello()));</span></div><div class="line"><span class="comment">//        //通过代理对象调用目标方法</span></div><div class="line"><span class="comment">//        iHello.sayHello();</span></div><div class="line"></div><div class="line">        <span class="comment">//生成$Proxy0的class文件</span></div><div class="line">        System.getProperties().put(<span class="string">"sun.misc.ProxyGenerator.saveGeneratedFiles"</span>, <span class="string">"true"</span>);</div><div class="line">        IHello ihello = (IHello) Proxy.newProxyInstance(IHello.class.getClassLoader(),  <span class="comment">//加载接口的类加载器</span></div><div class="line">                <span class="keyword">new</span> Class[]&#123;IHello.class&#125;,      <span class="comment">//一组接口</span></div><div class="line">                <span class="keyword">new</span> HWInvocationHandler(<span class="keyword">new</span> Hello())); <span class="comment">//自定义的InvocationHandler</span></div><div class="line">        ihello.sayHello();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="JDK动态代理过程"><a href="#JDK动态代理过程" class="headerlink" title="JDK动态代理过程"></a>JDK动态代理过程</h3><p><strong>JDK静态代理是通过直接编码创建的，而JDK动态代理是利用反射机制在运行时创建代理类的。</strong></p>
<p><strong>其实在动态代理中，核心是InvocationHandler。每一个代理的实例都会有一个关联的调用处理程序(InvocationHandler)。对待代理实例进行调用时，将对方法的调用进行编码并指派到它的调用处理器(InvocationHandler)的invoke方法。所以对代理对象实例方法的调用都是通过InvocationHandler中的invoke方法来完成的，而invoke方法会根据传入的代理对象、方法名称以及参数决定调用代理的哪个方法。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">IHello hello = <span class="keyword">new</span> Hello();</div><div class="line">InvocationHandler handler = <span class="keyword">new</span> HWInvocationHandler(hello);</div><div class="line">IHello ihello = (IHello) Proxy.newProxyInstance(HWInvocationHandler.getClass.getClassLoader(),</div><div class="line">                                                hello.getClass().getInterfaces(),</div><div class="line">                                                handler);</div><div class="line">ihello.sayHello();</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader,</span></span></div><div class="line"><span class="function"><span class="params">                                          Class&lt;?&gt;[] interfaces,</span></span></div><div class="line"><span class="function"><span class="params">                                          InvocationHandler h)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> IllegalArgumentException</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="comment">//如果h为空将抛出异常</span></div><div class="line">        Objects.requireNonNull(h);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Class&lt;?&gt;[] intfs = interfaces.clone();<span class="comment">//拷贝被代理类实现的一些接口，用于后面权限方面的一些检查</span></div><div class="line">        <span class="keyword">final</span> SecurityManager sm = System.getSecurityManager();</div><div class="line">        <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//在这里对某些安全权限进行检查，确保我们有权限对预期的被代理类进行代理</span></div><div class="line">            checkProxyAccess(Reflection.getCallerClass(), loader, intfs);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment">         * 下面这个方法将产生代理类</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line"><span class="comment">         * 使用指定的调用处理程序获取代理类的构造函数对象</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</div><div class="line">                checkNewProxyPermission(Reflection.getCallerClass(), cl);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);</div><div class="line">            <span class="keyword">final</span> InvocationHandler ih = h;</div><div class="line">            <span class="comment">//假如代理类的构造函数是private的，就使用反射来set accessible</span></div><div class="line">            <span class="keyword">if</span> (!Modifier.isPublic(cl.getModifiers())) &#123;</div><div class="line">                AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</div><div class="line">                    <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        cons.setAccessible(<span class="keyword">true</span>);</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//根据代理类的构造函数来生成代理类的对象并返回</span></div><div class="line">            <span class="keyword">return</span> cons.newInstance(<span class="keyword">new</span> Object[]&#123;h&#125;);</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException|InstantiationException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e.toString(), e);</div><div class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">            Throwable t = e.getCause();</div><div class="line">            <span class="keyword">if</span> (t <span class="keyword">instanceof</span> RuntimeException) &#123;</div><div class="line">                <span class="keyword">throw</span> (RuntimeException) t;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(t.toString(), t);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e.toString(), e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>然后通过    Class&lt;?&gt; cl = getProxyClass0(loader, intfs); 产生具体代理类，下面是具体过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">     * 生成一个代理类，但是在调用本方法之前必须进行权限检查</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Class&lt;?&gt; getProxyClass0(ClassLoader loader,</div><div class="line">                                           Class&lt;?&gt;... interfaces) &#123;</div><div class="line">        <span class="comment">//如果接口数量大于65535，抛出非法参数错误</span></div><div class="line">        <span class="keyword">if</span> (interfaces.length &gt; <span class="number">65535</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"interface limit exceeded"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">       </div><div class="line">        <span class="comment">// 如果在缓存中有对应的代理类，那么直接返回</span></div><div class="line">        <span class="comment">// 否则代理类将有 ProxyClassFactory 来创建</span></div><div class="line">        <span class="keyword">return</span> proxyClassCache.get(loader, interfaces);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ProxyClassFactory是什么？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">   *  里面有一个根据给定ClassLoader和Interface来创建代理类的工厂函数  </span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyClassFactory</span></span></div><div class="line">      implements BiFunction&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;</div><div class="line">  &#123;</div><div class="line">      <span class="comment">// 代理类的名字的前缀统一为“$Proxy”</span></div><div class="line">      <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String proxyClassNamePrefix = <span class="string">"$Proxy"</span>;</div><div class="line"></div><div class="line">      <span class="comment">// 每个代理类前缀后面都会跟着一个唯一的编号，如$Proxy0、$Proxy1、$Proxy2</span></div><div class="line">      <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicLong nextUniqueNumber = <span class="keyword">new</span> AtomicLong();</div><div class="line"></div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="keyword">public</span> Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) &#123;</div><div class="line"></div><div class="line">          Map&lt;Class&lt;?&gt;, Boolean&gt; interfaceSet = <span class="keyword">new</span> IdentityHashMap&lt;&gt;(interfaces.length);</div><div class="line">          <span class="keyword">for</span> (Class&lt;?&gt; intf : interfaces) &#123;</div><div class="line">              <span class="comment">/*</span></div><div class="line"><span class="comment">               * 验证类加载器加载接口得到对象是否与由apply函数参数传入的对象相同</span></div><div class="line"><span class="comment">               */</span></div><div class="line">              Class&lt;?&gt; interfaceClass = <span class="keyword">null</span>;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  interfaceClass = Class.forName(intf.getName(), <span class="keyword">false</span>, loader);</div><div class="line">              &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (interfaceClass != intf) &#123;</div><div class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                      intf + <span class="string">" is not visible from class loader"</span>);</div><div class="line">              &#125;</div><div class="line">              <span class="comment">/*</span></div><div class="line"><span class="comment">               * 验证这个Class对象是不是接口</span></div><div class="line"><span class="comment">               */</span></div><div class="line">              <span class="keyword">if</span> (!interfaceClass.isInterface()) &#123;</div><div class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                      interfaceClass.getName() + <span class="string">" is not an interface"</span>);</div><div class="line">              &#125;</div><div class="line">              <span class="comment">/*</span></div><div class="line"><span class="comment">               * 验证这个接口是否重复</span></div><div class="line"><span class="comment">               */</span></div><div class="line">              <span class="keyword">if</span> (interfaceSet.put(interfaceClass, Boolean.TRUE) != <span class="keyword">null</span>) &#123;</div><div class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                      <span class="string">"repeated interface: "</span> + interfaceClass.getName());</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          String proxyPkg = <span class="keyword">null</span>;     <span class="comment">// 声明代理类所在的package</span></div><div class="line">          <span class="keyword">int</span> accessFlags = Modifier.PUBLIC | Modifier.FINAL;</div><div class="line"></div><div class="line">          <span class="comment">/*</span></div><div class="line"><span class="comment">           * 记录一个非公共代理接口的包，以便在同一个包中定义代理类。同时验证所有非公共</span></div><div class="line"><span class="comment">           * 代理接口都在同一个包中</span></div><div class="line"><span class="comment">           */</span></div><div class="line">          <span class="keyword">for</span> (Class&lt;?&gt; intf : interfaces) &#123;</div><div class="line">              <span class="keyword">int</span> flags = intf.getModifiers();</div><div class="line">              <span class="keyword">if</span> (!Modifier.isPublic(flags)) &#123;</div><div class="line">                  accessFlags = Modifier.FINAL;</div><div class="line">                  String name = intf.getName();</div><div class="line">                  <span class="keyword">int</span> n = name.lastIndexOf(<span class="string">'.'</span>);</div><div class="line">                  String pkg = ((n == -<span class="number">1</span>) ? <span class="string">""</span> : name.substring(<span class="number">0</span>, n + <span class="number">1</span>));</div><div class="line">                  <span class="keyword">if</span> (proxyPkg == <span class="keyword">null</span>) &#123;</div><div class="line">                      proxyPkg = pkg;</div><div class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!pkg.equals(proxyPkg)) &#123;</div><div class="line">                      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                          <span class="string">"non-public interfaces from different packages"</span>);</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">if</span> (proxyPkg == <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="comment">// 如果全是公共代理接口，那么生成的代理类就在com.sun.proxy package下</span></div><div class="line">              proxyPkg = ReflectUtil.PROXY_PACKAGE + <span class="string">"."</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">/*</span></div><div class="line"><span class="comment">           * 为代理类生成一个name  package name + 前缀+唯一编号</span></div><div class="line"><span class="comment">           * 如 com.sun.proxy.$Proxy0.class</span></div><div class="line"><span class="comment">           */</span></div><div class="line">          <span class="keyword">long</span> num = nextUniqueNumber.getAndIncrement();</div><div class="line">          String proxyName = proxyPkg + proxyClassNamePrefix + num;</div><div class="line"></div><div class="line">          <span class="comment">/*</span></div><div class="line"><span class="comment">           * 生成指定代理类的字节码文件</span></div><div class="line"><span class="comment">           */</span></div><div class="line">          <span class="keyword">byte</span>[] proxyClassFile = ProxyGenerator.generateProxyClass(</div><div class="line">              proxyName, interfaces, accessFlags);</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              <span class="keyword">return</span> defineClass0(loader, proxyName,</div><div class="line">                                  proxyClassFile, <span class="number">0</span>, proxyClassFile.length);</div><div class="line">          &#125; <span class="keyword">catch</span> (ClassFormatError e) &#123;</div><div class="line">              <span class="comment">/*</span></div><div class="line"><span class="comment">               * A ClassFormatError here means that (barring bugs in the</span></div><div class="line"><span class="comment">               * proxy class generation code) there was some other</span></div><div class="line"><span class="comment">               * invalid aspect of the arguments supplied to the proxy</span></div><div class="line"><span class="comment">               * class creation (such as virtual machine limitations</span></div><div class="line"><span class="comment">               * exceeded).</span></div><div class="line"><span class="comment">               */</span></div><div class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e.toString());</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>由上方代码byte[] proxyClassFile = ProxyGenerator.generateProxyClass(proxyName, interfaces, accessFlags);可以看到，其实生成代理类字节码文件的工作是通过 ProxyGenerate类中的generateProxyClass方法来完成的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] generateProxyClass(<span class="keyword">final</span> String var0, Class&lt;?&gt;[] var1, <span class="keyword">int</span> var2) &#123;</div><div class="line">       ProxyGenerator var3 = <span class="keyword">new</span> ProxyGenerator(var0, var1, var2);</div><div class="line">      <span class="comment">// 真正用来生成代理类字节码文件的方法在这里</span></div><div class="line">       <span class="keyword">final</span> <span class="keyword">byte</span>[] var4 = var3.generateClassFile();</div><div class="line">      <span class="comment">// 保存代理类的字节码文件</span></div><div class="line">       <span class="keyword">if</span>(saveGeneratedFiles) &#123;</div><div class="line">           AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction() &#123;</div><div class="line">               <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                   <span class="keyword">try</span> &#123;</div><div class="line">                       <span class="keyword">int</span> var1 = var0.lastIndexOf(<span class="number">46</span>);</div><div class="line">                       Path var2;</div><div class="line">                       <span class="keyword">if</span>(var1 &gt; <span class="number">0</span>) &#123;</div><div class="line">                           Path var3 = Paths.get(var0.substring(<span class="number">0</span>, var1).replace(<span class="string">'.'</span>, File.separatorChar), </div><div class="line">                                                                                  <span class="keyword">new</span> String[<span class="number">0</span>]);</div><div class="line">                           Files.createDirectories(var3, <span class="keyword">new</span> FileAttribute[<span class="number">0</span>]);</div><div class="line">                           var2 = var3.resolve(var0.substring(var1 + <span class="number">1</span>, var0.length()) + <span class="string">".class"</span>);</div><div class="line">                       &#125; <span class="keyword">else</span> &#123;</div><div class="line">                           var2 = Paths.get(var0 + <span class="string">".class"</span>, <span class="keyword">new</span> String[<span class="number">0</span>]);</div><div class="line">                       &#125;</div><div class="line"></div><div class="line">                       Files.write(var2, var4, <span class="keyword">new</span> OpenOption[<span class="number">0</span>]);</div><div class="line">                       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                   &#125; <span class="keyword">catch</span> (IOException var4x) &#123;</div><div class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"I/O exception saving generated file: "</span> + var4x);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> var4;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] generateClassFile() &#123;</div><div class="line">        <span class="comment">//下面一系列的addProxyMethod方法是将接口中的方法和Object中的方法添加到代理方法中(proxyMethod)</span></div><div class="line">        <span class="keyword">this</span>.addProxyMethod(hashCodeMethod, Object.class);</div><div class="line">        <span class="keyword">this</span>.addProxyMethod(equalsMethod, Object.class);</div><div class="line">        <span class="keyword">this</span>.addProxyMethod(toStringMethod, Object.class);</div><div class="line">        Class[] var1 = <span class="keyword">this</span>.interfaces;</div><div class="line">        <span class="keyword">int</span> var2 = var1.length;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> var3;</div><div class="line">        Class var4;</div><div class="line">       <span class="comment">//获得接口中所有方法并添加到代理方法中</span></div><div class="line">        <span class="keyword">for</span>(var3 = <span class="number">0</span>; var3 &lt; var2; ++var3) &#123;</div><div class="line">            var4 = var1[var3];</div><div class="line">            Method[] var5 = var4.getMethods();</div><div class="line">            <span class="keyword">int</span> var6 = var5.length;</div><div class="line"></div><div class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var7 = <span class="number">0</span>; var7 &lt; var6; ++var7) &#123;</div><div class="line">                Method var8 = var5[var7];</div><div class="line">                <span class="keyword">this</span>.addProxyMethod(var8, var4);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Iterator var11 = <span class="keyword">this</span>.proxyMethods.values().iterator();</div><div class="line">        <span class="comment">//验证具有相同方法签名的方法的返回类型是否一致</span></div><div class="line">        List var12;</div><div class="line">        <span class="keyword">while</span>(var11.hasNext()) &#123;</div><div class="line">            var12 = (List)var11.next();</div><div class="line">            checkReturnTypes(var12);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//后面一系列的步骤用于写代理类Class文件</span></div><div class="line">        Iterator var15;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">             <span class="comment">//生成代理类的构造函数</span></div><div class="line">            <span class="keyword">this</span>.methods.add(<span class="keyword">this</span>.generateConstructor());</div><div class="line">            var11 = <span class="keyword">this</span>.proxyMethods.values().iterator();</div><div class="line"></div><div class="line">            <span class="keyword">while</span>(var11.hasNext()) &#123;</div><div class="line">                var12 = (List)var11.next();</div><div class="line">                var15 = var12.iterator();</div><div class="line"></div><div class="line">                <span class="keyword">while</span>(var15.hasNext()) &#123;</div><div class="line">                    ProxyGenerator.ProxyMethod var16 = (ProxyGenerator.ProxyMethod)var15.next();</div><div class="line">                    <span class="comment">//将代理类字段声明为Method，并且字段修饰符为 private static.</span></div><div class="line">                   <span class="comment">//因为 10 是 ACC_PRIVATE和ACC_STATIC的与运算 故代理类的字段都是 private static Method ***</span></div><div class="line">                    <span class="keyword">this</span>.fields.add(<span class="keyword">new</span> ProxyGenerator.FieldInfo(var16.methodFieldName, </div><div class="line">                                   <span class="string">"Ljava/lang/reflect/Method;"</span>, <span class="number">10</span>));</div><div class="line">                   <span class="comment">//生成代理类的方法</span></div><div class="line">                    <span class="keyword">this</span>.methods.add(var16.generateMethod());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">           <span class="comment">//为代理类生成静态代码块对某些字段进行初始化</span></div><div class="line">            <span class="keyword">this</span>.methods.add(<span class="keyword">this</span>.generateStaticInitializer());</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException var10) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"unexpected I/O Exception"</span>, var10);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.methods.size() &gt; <span class="string">'\uffff'</span>) &#123; <span class="comment">//代理类中的方法数量超过65535就抛异常</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"method limit exceeded"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.fields.size() &gt; <span class="string">'\uffff'</span>) &#123;<span class="comment">// 代理类中字段数量超过65535也抛异常</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"field limit exceeded"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 后面是对文件进行处理的过程</span></div><div class="line">            <span class="keyword">this</span>.cp.getClass(dotToSlash(<span class="keyword">this</span>.className));</div><div class="line">            <span class="keyword">this</span>.cp.getClass(<span class="string">"java/lang/reflect/Proxy"</span>);</div><div class="line">            var1 = <span class="keyword">this</span>.interfaces;</div><div class="line">            var2 = var1.length;</div><div class="line"></div><div class="line">            <span class="keyword">for</span>(var3 = <span class="number">0</span>; var3 &lt; var2; ++var3) &#123;</div><div class="line">                var4 = var1[var3];</div><div class="line">                <span class="keyword">this</span>.cp.getClass(dotToSlash(var4.getName()));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.cp.setReadOnly();</div><div class="line">            ByteArrayOutputStream var13 = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">            DataOutputStream var14 = <span class="keyword">new</span> DataOutputStream(var13);</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                var14.writeInt(-<span class="number">889275714</span>);</div><div class="line">                var14.writeShort(<span class="number">0</span>);</div><div class="line">                var14.writeShort(<span class="number">49</span>);</div><div class="line">                <span class="keyword">this</span>.cp.write(var14);</div><div class="line">                var14.writeShort(<span class="keyword">this</span>.accessFlags);</div><div class="line">                var14.writeShort(<span class="keyword">this</span>.cp.getClass(dotToSlash(<span class="keyword">this</span>.className)));</div><div class="line">                var14.writeShort(<span class="keyword">this</span>.cp.getClass(<span class="string">"java/lang/reflect/Proxy"</span>));</div><div class="line">                var14.writeShort(<span class="keyword">this</span>.interfaces.length);</div><div class="line">                Class[] var17 = <span class="keyword">this</span>.interfaces;</div><div class="line">                <span class="keyword">int</span> var18 = var17.length;</div><div class="line"></div><div class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> var19 = <span class="number">0</span>; var19 &lt; var18; ++var19) &#123;</div><div class="line">                    Class var22 = var17[var19];</div><div class="line">                    var14.writeShort(<span class="keyword">this</span>.cp.getClass(dotToSlash(var22.getName())));</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                var14.writeShort(<span class="keyword">this</span>.fields.size());</div><div class="line">                var15 = <span class="keyword">this</span>.fields.iterator();</div><div class="line"></div><div class="line">                <span class="keyword">while</span>(var15.hasNext()) &#123;</div><div class="line">                    ProxyGenerator.FieldInfo var20 = (ProxyGenerator.FieldInfo)var15.next();</div><div class="line">                    var20.write(var14);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                var14.writeShort(<span class="keyword">this</span>.methods.size());</div><div class="line">                var15 = <span class="keyword">this</span>.methods.iterator();</div><div class="line"></div><div class="line">                <span class="keyword">while</span>(var15.hasNext()) &#123;</div><div class="line">                    ProxyGenerator.MethodInfo var21 = (ProxyGenerator.MethodInfo)var15.next();</div><div class="line">                    var21.write(var14);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                var14.writeShort(<span class="number">0</span>);</div><div class="line">                <span class="keyword">return</span> var13.toByteArray();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException var9) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"unexpected I/O Exception"</span>, var9);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>下面是将接口与Object中一些方法添加到代理类中的addProxyMethod方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addProxyMethod</span><span class="params">(Method var1, Class&lt;?&gt; var2)</span> </span>&#123;</div><div class="line">        String var3 = var1.getName();<span class="comment">//获得方法名称</span></div><div class="line">        Class[] var4 = var1.getParameterTypes();<span class="comment">//获得方法参数类型</span></div><div class="line">        Class var5 = var1.getReturnType();<span class="comment">//获得方法返回类型</span></div><div class="line">        Class[] var6 = var1.getExceptionTypes();<span class="comment">//异常类型</span></div><div class="line">        String var7 = var3 + getParameterDescriptors(var4);<span class="comment">//获得方法签名</span></div><div class="line">        Object var8 = (List)<span class="keyword">this</span>.proxyMethods.get(var7);<span class="comment">//根据方法前面获得proxyMethod的value</span></div><div class="line">        <span class="keyword">if</span>(var8 != <span class="keyword">null</span>) &#123;<span class="comment">//处理多个代理接口中方法重复的情况</span></div><div class="line">            Iterator var9 = ((List)var8).iterator();</div><div class="line"></div><div class="line">            <span class="keyword">while</span>(var9.hasNext()) &#123;</div><div class="line">                ProxyGenerator.ProxyMethod var10 = (ProxyGenerator.ProxyMethod)var9.next();</div><div class="line">                <span class="keyword">if</span>(var5 == var10.returnType) &#123;</div><div class="line">                    ArrayList var11 = <span class="keyword">new</span> ArrayList();</div><div class="line">                    collectCompatibleTypes(var6, var10.exceptionTypes, var11);</div><div class="line">                    collectCompatibleTypes(var10.exceptionTypes, var6, var11);</div><div class="line">                    var10.exceptionTypes = <span class="keyword">new</span> Class[var11.size()];</div><div class="line">                    var10.exceptionTypes = (Class[])var11.toArray(var10.exceptionTypes);</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            var8 = <span class="keyword">new</span> ArrayList(<span class="number">3</span>);</div><div class="line">            <span class="keyword">this</span>.proxyMethods.put(var7, var8);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ((List)var8).add(<span class="keyword">new</span> ProxyGenerator.ProxyMethod(var3, var4, var5, var6, var2, <span class="keyword">null</span>));</div><div class="line">    &#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://originer.github.io/Horizon.github.io/Horizon.github.io/2018/05/01/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Horizon">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/Horizon.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Horizon Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Horizon.github.io/2018/05/01/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-01T01:36:28+08:00">
                2018-05-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://originer.github.io/Horizon.github.io/Horizon.github.io/2018/05/01/ajax跨域问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Horizon">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/Horizon.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Horizon Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Horizon.github.io/2018/05/01/ajax跨域问题/" itemprop="url">ajax跨域问题整理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-01T01:36:28+08:00">
                2018-05-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="为什么会出现跨域"><a href="#为什么会出现跨域" class="headerlink" title="为什么会出现跨域"></a>为什么会出现跨域</h3><p>跨域问题来源于JavaScript的同源策略，即只有 协议+主机名+端口号<br>(如存在)相同，则允许相互访问。也就是说JavaScript只能访问和操作自己域下的资源，不能访问和操作其他域下的资源。跨域问题是针对JS和ajax的，html本身没有跨域问题，比如a标签、script标签、甚至form标签（可以直接跨域发送数据并接收数据）等</p>
<p><img src="http://okydwk9zh.bkt.clouddn.com/17-5-28/79583948.jpg" alt="img"></p>
<p>说白了，产生跨域的主要原因就是浏览器的限制。</p>
<h3 id="如何解决跨域问题"><a href="#如何解决跨域问题" class="headerlink" title="如何解决跨域问题"></a>如何解决跨域问题</h3><ul>
<li><p>JSONP </p>
<p>　　JSONP是JSON with Padding的略称。它是一个非官方的协议，它允许在服务器端集成Script<br>  tags返回至客户端，通过javascript<br>  callback的形式实现跨域访问（这仅仅是JSONP简单的实现形式）。关于jsonp的使用方式，可以参考<a href="http://blog.csdn.net/alen1985/article/details/6365394" target="_blank" rel="external">http://blog.csdn.net/alen1985/article/details/6365394</a>，优缺点可以参考<a href="http://blog.csdn.net/z69183787/article/details/19191385" target="_blank" rel="external">http://blog.csdn.net/z69183787/article/details/19191385</a>　　</p>
</li>
<li><p>添加响应头，允许跨域 </p>
<p>　　addHeader(‘Access-Control-Allow-Origin:*’);//允许所有来源访问 </p>
<p>　　addHeader(‘Access-Control-Allow-Method:POST,GET’);//允许访问的方式</p>
</li>
<li><p>代理的方式 </p>
<p>服务器A的test01.html页面想访问服务器B的后台action，返回“test”字符串，此时就出现跨域请求，浏览器控制台会出现报错提示，由于跨域是浏览器的同源策略造成的，对于服务器后台不存在该问题，可以在服务器A中添加一个代理action，在该action中完成对服务器B中action数据的请求，然后在返回到test01.html页面。</p>
</li>
</ul>
<h4 id="JSONP"><a href="#JSONP" class="headerlink" title="JSONP"></a>JSONP</h4><p>JSONP的最基本的原理是：动态添加一个<script>标签，而script标签的src属性是没有跨域的限制的。这样说来，这种跨域方式其实与ajax XmlHttpRequest协议无关了。</p>
<p><strong>JSONP的优点</strong>：它不像XMLHttpRequest对象实现的Ajax请求那样受到同源策略的限制；它的兼容性更好，在更加古老的浏览器中都 可以运行，不需要XMLHttpRequest或ActiveX的支持；并且在请求完毕后可以通过调用callback的方式回传结果。</p>
<p><strong>JSONP的缺点</strong>：它只支持GET请求而不支持POST等其它类型的HTTP请求；它只支持跨域HTTP请求这种情况，不能解决不同域的两个页面之间如何进行JavaScript调用的问题。</p>
<p>Jsonp的执行过程如下：</p>
<p><em>首先在客户端注册一个callback (如:’jsoncallback’),</em><br><em>然后把callback的名字(如:jsonp1236827957501)传给服务器。注意：服务端得到callback的数值后，要用jsonp1236827957501(……)把将要输出的json内容包括起来，此时，服务器生成</em><br> json 数据才能被客户端正确接收。</p>
<p><em>然后以 javascript 语法的方式，生成一个function， function 名字就是传递上来的参数 ‘jsoncallback’的值 jsonp1236827957501 .</em></p>
<p><em>最后将 json 数据直接以入参的方式，放置到 function 中，这样就生成了一段 js 语法的文档，返回给客户端。</em></p>
<p>客户端浏览器，解析script标签，并执行返回的 javascript 文档，此时javascript文档数据，作为参数，<br>传入到了客户端预先定义好的 callback 函数(如上例中jquery $.ajax()方法封装的的success: function<br><em>(json))里。</em></p>
<p>可以说jsonp的方式原理上和<script 
*src="http://跨域/...xx.js"></script>是一致的(qq空间就是大量采用这种方式来实现跨域数据交换的)。JSONP是一种脚本注入(Script<em>
 </em>Injection)行为，所以有一定的安全隐患。*</p>
<p>例如，我们通过jquery的ajax发送一个jsonp的请求：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$.ajax(&#123;</div><div class="line">   url: base +<span class="string">"/get1"</span>,</div><div class="line">   dataType: <span class="string">"jsonp"</span>,</div><div class="line">   jsonp: <span class="string">"callback2"</span>,</div><div class="line">   cache:<span class="literal">true</span>,</div><div class="line">   success: <span class="function"><span class="keyword">function</span>(<span class="params">json</span>)</span>&#123;</div><div class="line">      result = json;</div><div class="line">   &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>后台接收也要做一些修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ControllerAdvice</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonpAdvice</span> <span class="keyword">extends</span> <span class="title">AbstractJsonpResponseBodyAdvice</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">JsonpAdvice</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="comment">// TODO Auto-generated constructor stub</span></div><div class="line">      <span class="keyword">super</span>(<span class="string">"callback2"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>​    </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://originer.github.io/Horizon.github.io/Horizon.github.io/2018/05/01/Netty学习笔记(一)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Horizon">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/Horizon.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Horizon Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Horizon.github.io/2018/05/01/Netty学习笔记(一)/" itemprop="url">Netty学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-01T01:36:28+08:00">
                2018-05-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Horizon.github.io/categories/网络编程/" itemprop="url" rel="index">
                    <span itemprop="name">网络编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><em>这是本人学习Netty过程中记录的笔记，方便以后快速回顾。</em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://originer.github.io/Horizon.github.io/Horizon.github.io/2018/05/01/NIO Channel和Buffer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Horizon">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/Horizon.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Horizon Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Horizon.github.io/2018/05/01/NIO Channel和Buffer/" itemprop="url">深入浅出NIO Channel和Buffer</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-01T01:36:28+08:00">
                2018-05-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Horizon.github.io/categories/网络编程/" itemprop="url" rel="index">
                    <span itemprop="name">网络编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Java NIO 由以下几个核心部分组成：</p>
<ol>
<li>Buffer </li>
<li>Channel</li>
<li>Selector</li>
</ol>
<p>传统的IO操作面向数据流，意味着每次从流中读一个或多个字节，直至完成，数据没有被缓存在任何地方。NIO操作面向缓冲区，数据从Channel读取到Buffer缓冲区，随后在Buffer中处理数据。本文着重介绍Channel和Buffer的概念以及在文件读写方面的应用和内部实现原理。</p>
<h3 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h3><blockquote>
<p>A buffer is a linear, finite sequence of elements of a specific primitive type.</p>
</blockquote>
<p>一块缓存区，内部使用字节数组存储数据，并维护几个特殊变量，实现数据的反复利用。</p>
<ul>
<li><strong>mark</strong>：初始值为-1，用于备份当前的position</li>
<li><strong>position</strong>：初始值为0。position表示当前可以写入或读取数据的位置。当写入或读取一个数据后， position向前移动到下一个位置。</li>
<li><strong>limit</strong>：<br>写模式下，limit表示最多能往Buffer里写多少数据，等于capacity值。<br>读模式下，limit表示最多可以读取多少数据。</li>
<li><strong>capacity</strong>：缓存数组大小</li>
</ul>
<p>Buffer.png</p>
<p><strong>mark()</strong>：把当前的position赋值给mark</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">mark</span><span class="params">()</span> </span>&#123;</div><div class="line">    mark = position;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>reset()</strong>：把mark值还原给position</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">reset</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> m = mark;</div><div class="line">    <span class="keyword">if</span> (m &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidMarkException();</div><div class="line">    position = m;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>clear()</strong>：一旦读完Buffer中的数据，需要让Buffer准备好再次被写入，clear会恢复状态值，但不会擦除数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public final Buffer clear() &#123;</div><div class="line">    position = 0;</div><div class="line">    limit = capacity;</div><div class="line">    mark = -1;</div><div class="line">    return this;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>flip()</strong>：Buffer有两种模式，写模式和读模式，flip后Buffer从写模式变成读模式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">flip</span><span class="params">()</span> </span>&#123;</div><div class="line">    limit = position;</div><div class="line">    position = <span class="number">0</span>;</div><div class="line">    mark = -<span class="number">1</span>;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>rewind()</strong>：重置position为0，从头读写数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">rewind</span><span class="params">()</span> </span>&#123;</div><div class="line">    position = <span class="number">0</span>;</div><div class="line">    mark = -<span class="number">1</span>;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>目前Buffer的实现类有以下几种：</p>
<ul>
<li>ByteBuffer</li>
<li>CharBuffer</li>
<li>DoubleBuffer</li>
<li>FloatBuffer</li>
<li>IntBuffer</li>
<li>LongBuffer</li>
<li>ShortBuffer</li>
<li>MappedByteBuffer</li>
</ul>
<p>其中MappedByteBuffer实现比较特殊，感兴趣的可以看看 <a href="http://www.jianshu.com/p/f90866dcbffc" target="_blank" rel="external">深入浅出MappedByteBuffer</a></p>
<p>Paste_Image.png</p>
<h3 id="ByteBuffer"><a href="#ByteBuffer" class="headerlink" title="ByteBuffer"></a>ByteBuffer</h3><blockquote>
<p>A byte buffer，extend from Buffer</p>
</blockquote>
<p>ByteBuffer的实现类包括HeapByteBuffer和DirectByteBuffer两种。</p>
<ul>
<li><p><strong>HeapByteBuffer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title">allocate</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (capacity &lt; <span class="number">0</span>)</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> HeapByteBuffer(capacity, capacity);</div><div class="line">&#125;</div><div class="line">HeapByteBuffer(<span class="keyword">int</span> cap, <span class="keyword">int</span> lim) &#123;  </div><div class="line">  <span class="keyword">super</span>(-<span class="number">1</span>, <span class="number">0</span>, lim, cap, <span class="keyword">new</span> <span class="keyword">byte</span>[cap], <span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HeapByteBuffer通过初始化字节数组hd，在虚拟机堆上申请内存空间。</p>
</li>
<li><p><strong>DirectByteBuffer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title">allocateDirect</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> DirectByteBuffer(capacity);</div><div class="line">&#125;</div><div class="line">DirectByteBuffer(<span class="keyword">int</span> cap) &#123;</div><div class="line">  <span class="keyword">super</span>(-<span class="number">1</span>, <span class="number">0</span>, cap, cap);</div><div class="line">  <span class="keyword">boolean</span> pa = VM.isDirectMemoryPageAligned();</div><div class="line">  <span class="keyword">int</span> ps = Bits.pageSize();</div><div class="line">  <span class="keyword">long</span> size = Math.max(<span class="number">1L</span>, (<span class="keyword">long</span>)cap + (pa ? ps : <span class="number">0</span>));</div><div class="line">  Bits.reserveMemory(size, cap);</div><div class="line"></div><div class="line">  <span class="keyword">long</span> base = <span class="number">0</span>;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      base = unsafe.allocateMemory(size);</div><div class="line">  &#125; <span class="keyword">catch</span> (OutOfMemoryError x) &#123;</div><div class="line">      Bits.unreserveMemory(size, cap);</div><div class="line">      <span class="keyword">throw</span> x;</div><div class="line">  &#125;</div><div class="line">  unsafe.setMemory(base, size, (<span class="keyword">byte</span>) <span class="number">0</span>);</div><div class="line">  <span class="keyword">if</span> (pa &amp;&amp; (base % ps != <span class="number">0</span>)) &#123;</div><div class="line">      <span class="comment">// Round up to page boundary</span></div><div class="line">      address = base + ps - (base &amp; (ps - <span class="number">1</span>));</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">      address = base;</div><div class="line">  &#125;</div><div class="line">  cleaner = Cleaner.create(<span class="keyword">this</span>, <span class="keyword">new</span> Deallocator(base, size, cap));</div><div class="line">  att = <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>DirectByteBuffer通过unsafe.allocateMemory在物理内存中申请地址空间（非jvm堆内存），并在ByteBuffer的address变量中维护指向该内存的地址。<br>unsafe.setMemory(base, size, (byte) 0)方法把新申请的内存数据清零。</p>
</li>
</ul>
<h3 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h3><blockquote>
<p>A channel represents an open connection to an entity such as a hardware device, a file, a network socket, or a program component that is capable of performing one or more distinct I/O operations, for example reading or writing.</p>
</blockquote>
<p>又称“通道”，NIO把它支持的I/O对象抽象为Channel，类似于原I/O中的流（Stream），但有所区别：</p>
<ul>
<li>流是单向的，通道是双向的，可读可写。</li>
<li>流读写是阻塞的，通道可以异步读写。</li>
<li>流中的数据可以选择性的先读到缓存中，通道的数据总是要先读到一个缓存中，或从缓存中写入，如下所示：</li>
</ul>
<p>Channel.png</p>
<p>目前已知Channel的实现类有：</p>
<ul>
<li>FileChannel</li>
<li>DatagramChannel</li>
<li>SocketChannel</li>
<li>ServerSocketChannel</li>
</ul>
<h3 id="FileChannel"><a href="#FileChannel" class="headerlink" title="FileChannel"></a>FileChannel</h3><blockquote>
<p>A channel for reading, writing, mapping, and manipulating a file.<br>一个用来写、读、映射和操作文件的通道。</p>
</blockquote>
<p>FileChannel的read、write和map通过其实现类FileChannelImpl实现。</p>
<ul>
<li><p><strong>read实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(ByteBuffer dst)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  ensureOpen();</div><div class="line">  <span class="keyword">if</span> (!readable)</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NonReadableChannelException();</div><div class="line">  <span class="keyword">synchronized</span> (positionLock) &#123;</div><div class="line">      <span class="keyword">int</span> n = <span class="number">0</span>;</div><div class="line">      <span class="keyword">int</span> ti = -<span class="number">1</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          begin();</div><div class="line">          ti = threads.add();</div><div class="line">          <span class="keyword">if</span> (!isOpen())</div><div class="line">              <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">          <span class="keyword">do</span> &#123;</div><div class="line">              n = IOUtil.read(fd, dst, -<span class="number">1</span>, nd);</div><div class="line">          &#125; <span class="keyword">while</span> ((n == IOStatus.INTERRUPTED) &amp;&amp; isOpen());</div><div class="line">          <span class="keyword">return</span> IOStatus.normalize(n);</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          threads.remove(ti);</div><div class="line">          end(n &gt; <span class="number">0</span>);</div><div class="line">          <span class="keyword">assert</span> IOStatus.check(n);</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>FileChannelImpl的read方法通过IOUtil的read实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(FileDescriptor fd, ByteBuffer dst, <span class="keyword">long</span> position,</span></span></div><div class="line"><span class="function"><span class="params">              NativeDispatcher nd)</span> IOException </span>&#123;</div><div class="line">  <span class="keyword">if</span> (dst.isReadOnly())</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Read-only buffer"</span>);</div><div class="line">  <span class="keyword">if</span> (dst <span class="keyword">instanceof</span> DirectBuffer)</div><div class="line">      <span class="keyword">return</span> readIntoNativeBuffer(fd, dst, position, nd);</div><div class="line"></div><div class="line">  <span class="comment">// Substitute a native buffer</span></div><div class="line">  ByteBuffer bb = Util.getTemporaryDirectBuffer(dst.remaining());</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">int</span> n = readIntoNativeBuffer(fd, bb, position, nd);</div><div class="line">      bb.flip();</div><div class="line">      <span class="keyword">if</span> (n &gt; <span class="number">0</span>)</div><div class="line">          dst.put(bb);</div><div class="line">      <span class="keyword">return</span> n;</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      Util.offerFirstTemporaryDirectBuffer(bb);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过上述实现可以看出，基于channel的文件数据读取步骤如下：<br>1、申请一块和缓存同大小的DirectByteBuffer bb。<br>2、读取数据到缓存bb，底层由NativeDispatcher的read实现。<br>3、把bb的数据读取到dst（用户定义的缓存，在jvm中分配内存）。<br><strong>read方法导致数据复制了两次</strong>。</p>
</li>
<li><p><strong>write实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">write</span><span class="params">(ByteBuffer src)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  ensureOpen();</div><div class="line">  <span class="keyword">if</span> (!writable)</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NonWritableChannelException();</div><div class="line">  <span class="keyword">synchronized</span> (positionLock) &#123;</div><div class="line">      <span class="keyword">int</span> n = <span class="number">0</span>;</div><div class="line">      <span class="keyword">int</span> ti = -<span class="number">1</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          begin();</div><div class="line">          ti = threads.add();</div><div class="line">          <span class="keyword">if</span> (!isOpen())</div><div class="line">              <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">          <span class="keyword">do</span> &#123;</div><div class="line">              n = IOUtil.write(fd, src, -<span class="number">1</span>, nd);</div><div class="line">          &#125; <span class="keyword">while</span> ((n == IOStatus.INTERRUPTED) &amp;&amp; isOpen());</div><div class="line">          <span class="keyword">return</span> IOStatus.normalize(n);</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          threads.remove(ti);</div><div class="line">          end(n &gt; <span class="number">0</span>);</div><div class="line">          <span class="keyword">assert</span> IOStatus.check(n);</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>和read实现一样，FileChannelImpl的write方法通过IOUtil的write实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">write</span><span class="params">(FileDescriptor fd, ByteBuffer src, <span class="keyword">long</span> position,</span></span></div><div class="line"><span class="function"><span class="params">               NativeDispatcher nd)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  <span class="keyword">if</span> (src <span class="keyword">instanceof</span> DirectBuffer)</div><div class="line">      <span class="keyword">return</span> writeFromNativeBuffer(fd, src, position, nd);</div><div class="line">  <span class="comment">// Substitute a native buffer</span></div><div class="line">  <span class="keyword">int</span> pos = src.position();</div><div class="line">  <span class="keyword">int</span> lim = src.limit();</div><div class="line">  <span class="keyword">assert</span> (pos &lt;= lim);</div><div class="line">  <span class="keyword">int</span> rem = (pos &lt;= lim ? lim - pos : <span class="number">0</span>);</div><div class="line">  ByteBuffer bb = Util.getTemporaryDirectBuffer(rem);</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      bb.put(src);</div><div class="line">      bb.flip();</div><div class="line">      <span class="comment">// Do not update src until we see how many bytes were written</span></div><div class="line">      src.position(pos);</div><div class="line">      <span class="keyword">int</span> n = writeFromNativeBuffer(fd, bb, position, nd);</div><div class="line">      <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</div><div class="line">          <span class="comment">// now update src</span></div><div class="line">          src.position(pos + n);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> n;</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      Util.offerFirstTemporaryDirectBuffer(bb);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过上述实现可以看出，基于channel的文件数据写入步骤如下：<br>1、申请一块DirectByteBuffer，bb大小为byteBuffer中的limit - position。<br>2、复制byteBuffer中的数据到bb中。<br>3、把数据从bb中写入到文件，底层由NativeDispatcher的write实现，具体如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">writeFromNativeBuffer</span><span class="params">(FileDescriptor fd, </span></span></div><div class="line"><span class="function"><span class="params">      ByteBuffer bb, <span class="keyword">long</span> position, NativeDispatcher nd)</span></span></div><div class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  <span class="keyword">int</span> pos = bb.position();</div><div class="line">  <span class="keyword">int</span> lim = bb.limit();</div><div class="line">  <span class="keyword">assert</span> (pos &lt;= lim);</div><div class="line">  <span class="keyword">int</span> rem = (pos &lt;= lim ? lim - pos : <span class="number">0</span>);</div><div class="line"></div><div class="line">  <span class="keyword">int</span> written = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span> (rem == <span class="number">0</span>)</div><div class="line">      <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span> (position != -<span class="number">1</span>) &#123;</div><div class="line">      written = nd.pwrite(fd,</div><div class="line">                          ((DirectBuffer)bb).address() + pos,</div><div class="line">                          rem, position);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">      written = nd.write(fd, ((DirectBuffer)bb).address() + pos, rem);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (written &gt; <span class="number">0</span>)</div><div class="line">      bb.position(pos + written);</div><div class="line">  <span class="keyword">return</span> written;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>write方法也导致了数据复制了两次</strong></p>
</li>
</ul>
<h3 id="Channel和Buffer示例"><a href="#Channel和Buffer示例" class="headerlink" title="Channel和Buffer示例"></a>Channel和Buffer示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">File file = <span class="keyword">new</span> RandomAccessFile(<span class="string">"data.txt"</span>, <span class="string">"rw"</span>);</div><div class="line">FileChannel channel = file.getChannel();</div><div class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">48</span>);</div><div class="line"></div><div class="line"><span class="keyword">int</span> bytesRead = channel.read(buffer);</div><div class="line"><span class="keyword">while</span> (bytesRead != -<span class="number">1</span>) &#123;</div><div class="line">    System.out.println(<span class="string">"Read "</span> + bytesRead);</div><div class="line">    buffer.flip();</div><div class="line">    <span class="keyword">while</span>(buffer.hasRemaining())&#123;</div><div class="line">        System.out.print((<span class="keyword">char</span>) buffer.get());</div><div class="line">    &#125;</div><div class="line">    buffer.clear();</div><div class="line">    bytesRead = channel.read(buffer);</div><div class="line">&#125;</div><div class="line">file.close();</div></pre></td></tr></table></figure>
<p>注意buffer.flip() 的调用，首先将数据写入到buffer，然后变成读模式，再从buffer中读取数据。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://originer.github.io/Horizon.github.io/Horizon.github.io/2018/05/01/Java虚拟机学习笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Horizon">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/Horizon.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Horizon Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Horizon.github.io/2018/05/01/Java虚拟机学习笔记/" itemprop="url">Java虚拟机学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-01T01:36:28+08:00">
                2018-05-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/Horizon.github.io/categories/JVM/" itemprop="url" rel="index">
                    <span itemprop="name">JVM</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Java内存区域与内存溢出异常"><a href="#Java内存区域与内存溢出异常" class="headerlink" title="Java内存区域与内存溢出异常"></a>Java内存区域与内存溢出异常</h2><h3 id="运行时数据区域"><a href="#运行时数据区域" class="headerlink" title="运行时数据区域"></a>运行时数据区域</h3><p>下图是Java运行时数据区域划分图</p>
<p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a8492a45653e?imageView2/0/w/1280/h/960/ignore-error/1" alt="运行时数据区域"></p>
<table>
<thead>
<tr>
<th>区域</th>
<th>是否线程共享</th>
<th>是否会内存溢出</th>
</tr>
</thead>
<tbody>
<tr>
<td>程序计数器</td>
<td>否</td>
<td>不会</td>
</tr>
<tr>
<td>java虚拟机栈</td>
<td>否</td>
<td>会</td>
</tr>
<tr>
<td>本地方法栈</td>
<td>否</td>
<td>会</td>
</tr>
<tr>
<td>堆</td>
<td>是</td>
<td>会</td>
</tr>
<tr>
<td>方法区</td>
<td>是</td>
<td>会</td>
</tr>
</tbody>
</table>
<h4 id="1-程序计数器-线程私有"><a href="#1-程序计数器-线程私有" class="headerlink" title="1.程序计数器(线程私有)"></a>1.程序计数器(线程私有)</h4><ul>
<li>一块较小的内存，可以看作是当前线程所执行的字节码的行号指示器；</li>
<li>在虚拟机概念模型（各种虚拟机实现可能不一样）中，字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令；</li>
<li>程序计数器是属于线程私有的内存；</li>
<li>如果执行的是Java方法，该计数器记录的是正在执行的虚拟机字节码指令的地址；如果是Native方法则为空；</li>
</ul>
<h4 id="2-Java虚拟机栈（线程私有）"><a href="#2-Java虚拟机栈（线程私有）" class="headerlink" title="2.Java虚拟机栈（线程私有）"></a>2.Java虚拟机栈（线程私有）</h4><ul>
<li>Java虚拟机栈也是线程私有的；</li>
<li>描述的是Java方法执行的内存模型：每个方法在执行的同时都会创建一个栈帧（Stack Frame）用于存储<code>局部变量表</code>、<code>操作数栈</code>、<code>动态链接</code>、<code>方法出口</code>等信息。每一个方法从调用直至执行完成的过程，就对应着一个栈帧在虚拟机中入栈到出栈的过程；</li>
<li><strong>局部变量表存放了编译器可知的各种基本数据类型、对象引用和returnAddress类型</strong>；其所需的内存空间在编辑期完成分配，不会再运行期改变；</li>
<li>可能存在两种异常：<code>StackOverflowError</code>(请求栈深度过大)和<code>OutOfMemoryError</code>（内存不够时）；</li>
</ul>
<h4 id="3-本地方法栈"><a href="#3-本地方法栈" class="headerlink" title="3.本地方法栈"></a>3.本地方法栈</h4><ul>
<li>与虚拟机栈非常相似，只不过是为虚拟机使用到的Native方法服务；</li>
<li>可能存在两种异常：StackOverflowError和OutOfMemoryError；</li>
</ul>
<h4 id="4-Java堆（线程共享）"><a href="#4-Java堆（线程共享）" class="headerlink" title="4.Java堆（线程共享）"></a>4.Java堆（线程共享）</h4><ul>
<li>Java堆是被所有线程共享的，在虚拟机启动时创建；</li>
<li>此内存区域的唯一目的就是存放对象实例，几乎所有的对象实例都在这分配；</li>
<li>是垃圾收集器管理的主要区域，可以分为<code>新生代</code>和<code>老年代</code>；</li>
<li>可以物理不连续，只要逻辑上是连续的即可；</li>
<li>如果堆中没有内存完成实例分配也无法再扩展时，会抛出OutOfMemoryError异常；</li>
</ul>
<h4 id="5-方法区-元空间（永久代）（线程共享）"><a href="#5-方法区-元空间（永久代）（线程共享）" class="headerlink" title="5.方法区/元空间（永久代）（线程共享）"></a>5.方法区/元空间（永久代）（线程共享）</h4><ul>
<li>是线程共享的区域；</li>
<li>用于存储已被虚拟机加载的<code>类信息</code>、<code>常量</code>、<code>静态变量</code>、即时编译器编译后的代码等数据；</li>
<li>该区域对于垃圾收集来说条件比较苛刻，但是还是非常有必要要进行回收处理；</li>
<li>当无法满足内存分配需求时，将抛出OutOfMemoryError异常；</li>
</ul>
<h4 id="6-运行时常量池"><a href="#6-运行时常量池" class="headerlink" title="6.运行时常量池"></a>6.运行时常量池</h4><ul>
<li>是方法区的一部分；</li>
<li>Class文件中除了有类的版本、字段、方法、接口等描述信息外，还有一项信息是常量池，用于存放编译器生成的各种字面量和符号引用，这部分内容将在类加载后进入方法区的运行时常量池中存放；</li>
<li>Java虚拟机规范要求较少，通常还会把翻译出来的直接引用也存储在此；</li>
<li>另外一个重要特征是具备动态性，可以在运行期间将新的常量放入池中，如String的intern方法；</li>
<li>可能存在的异常：OutOfMemoryError；</li>
</ul>
<h4 id="7-直接内存"><a href="#7-直接内存" class="headerlink" title="7.直接内存"></a>7.直接内存</h4><ul>
<li>并不是虚拟机运行时数据区的一部分，也不是Java虚拟机规范中定义的内存区域；</li>
<li>JDK 1.4的NIO引入了基于通道（Channel）和缓冲区（Buffer）的IO方法，可以使用Native函数库直接分配对外内存，然后通过一个存储在Java堆中的DirectByteBuffer对象作为这块内存的引用进行操作以提升性能；</li>
</ul>
<h3 id="对象的访问定位"><a href="#对象的访问定位" class="headerlink" title="对象的访问定位"></a>对象的访问定位</h3><ul>
<li>栈上的reference类型在虚拟机规范中只规定了一个指向对象的引用，并没有定义这个引用应该通过何种方式去定位、访问堆栈对象的具体位置，目前主流的方式方式有<code>句柄</code>和<code>直接指针</code>两种。</li>
<li>通过句柄：Java堆中划出一块内存作为句柄池，reference中存储的就是对象的句柄地址，而句柄中包含了对象实例数据与类型数据各自的具体地址信息。其最大好处就是reference存储的是稳定的句柄地址，在对象被移动（垃圾收集时移到）只改变实例数据指针，而reference不需要修改；</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a8492ec41c53?imageView2/0/w/1280/h/960/ignore-error/1" alt="通过句柄访问对象"></p>
<ul>
<li>通过直接指针：Java堆对象的布局中必须考虑如果放置访问类型数据的相关信息，而reference中存在的直接就是对象地址。其最大好处在于速度更快，节省了一次指针定位的时机开销。<strong>HotSpot采用该方式进行对象访问，但其他语言和框架采用句柄的也非常常见。</strong></li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a8492d4ffe79?imageView2/0/w/1280/h/960/ignore-error/1" alt="通过直接指针"></p>
<h2 id="Java垃圾回收机器与内存分配策略"><a href="#Java垃圾回收机器与内存分配策略" class="headerlink" title="Java垃圾回收机器与内存分配策略"></a>Java垃圾回收机器与内存分配策略</h2><p>程序计时器、虚拟机栈、本地方法栈：<strong>随线程而灭</strong>，栈帧随方法而进行出栈和入栈，每一个栈帧分配的内存在类结构确定就已知，<strong>因此这几个区域不需要考虑回收</strong>；</p>
<p>对于Java堆和方法区，只有程序运行期间才知道会创建哪些对象，内存的分配和回收都是动态的，<strong>垃圾收集器所关注的是这部分内存</strong>；</p>
<h3 id="判断Java中对象存活的算法"><a href="#判断Java中对象存活的算法" class="headerlink" title="判断Java中对象存活的算法"></a>判断Java中对象存活的算法</h3><h4 id="1-引用计数算法"><a href="#1-引用计数算法" class="headerlink" title="1.引用计数算法"></a>1.引用计数算法</h4><p>给对象添加引用计数器，当有地方引用它时就加1，引用失效就减1，为0时就认为对象不再被使用可回收。该算法失效简单，判断高效，但并不被主流虚拟机采用，主要原因是它很难解决对象之间相互循环引用的问题。</p>
<h4 id="2-可达性分析算法"><a href="#2-可达性分析算法" class="headerlink" title="2.可达性分析算法"></a>2.可达性分析算法</h4><p>通过一系列的称为“GC Roots”的对象作为起点，从这些节点开始向下搜索，搜索所走过的路径称为引用链（Reference Chain），如果一个对象到GC Roots没有引用链相连，则该对象是不可用的。</p>
<p><strong>在Java语言中，可作为GC Roots的对象包括：</strong></p>
<ul>
<li>虚拟机栈（栈帧中的本地变量表）中引用的对象；</li>
<li>方法区中类静态属性引用的对象；</li>
<li>方法区中常量引用的对象；</li>
<li>本地方法栈中JNI（即一般说的Native方法）引用的对象；</li>
</ul>
<h3 id="垃圾收集算法"><a href="#垃圾收集算法" class="headerlink" title="垃圾收集算法"></a>垃圾收集算法</h3><ul>
<li>1.标记-清除算法(Mark-Sweep)：首先标记出所有需要回收的对象，然后统一回收所有被标记的对象；缺点是效率不高且容易产生大量不连续的内存碎片；</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a8492f8c5b5c?imageView2/0/w/1280/h/960/ignore-error/1" alt="标记-清除算法"></p>
<ul>
<li>复制算法：将可用内存分为大小相等的两块，每次只使用其中一块；当这一块用完了，就将还活着的对象复制到另一块上，然后把已使用过的内存清理掉。在HotSpot里，考虑到大部分对象存活时间很短将内存分为Eden和两块Survivor，默认比例为8:1:1。代价是存在部分内存空间浪费，<strong>适合在新生代使用</strong>；</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a849305d845e?imageView2/0/w/1280/h/960/ignore-error/1" alt="复制算法"></p>
<ul>
<li><p>标记-整理算法：首先标记出所有需要回收的对象，然后让所有存活的对象都向一端移动，然后直接清理掉端边界以外的内存。<strong>适用于老年代</strong>。</p>
<p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a849722ff7b5?imageView2/0/w/1280/h/960/ignore-error/1" alt="标记-整理算法"></p>
<p>​</p>
</li>
<li><p>分代收集算法：一般把Java堆分新生代和老年代，<strong>在新生代用复制算法</strong>，<strong>在老年代用标记-清理或标记-整理算法</strong>，是现代虚拟机通常采用的算法。</p>
</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a84972a0a771?imageView2/0/w/1280/h/960/ignore-error/1" alt="分代收集算法"></p>
<h3 id="垃圾收集器"><a href="#垃圾收集器" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h3><ul>
<li>垃圾收集算法是内存回收的方法论，垃圾收集器就是内存回收的具体实现。</li>
<li>这里讨论JDK 1.7 Update 14之后的HotSpot虚拟机（此时G1仍处于实验状态），包含的虚拟机如下图所示（<strong>存在连线的表示可以搭配使用</strong>）：</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a8497436b487?imageView2/0/w/1280/h/960/ignore-error/1" alt="gc_for_hotspot"></p>
<h4 id="1-Serial收集器（单线程的收集器）"><a href="#1-Serial收集器（单线程的收集器）" class="headerlink" title="1.Serial收集器（单线程的收集器）"></a>1.Serial收集器（单线程的收集器）</h4><p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a84977b77781?imageView2/0/w/1280/h/960/ignore-error/1" alt="Serial收集器"></p>
<ul>
<li>最基本、发展历史最悠久，在JDK 1.3之前是新生代收集的唯一选择；</li>
<li>是一个单线程（并非指一个收集线程，而是会暂停所有工作线程）的收集器，采用的是复制算法;</li>
<li>现在依然是虚拟机运行在Client模式下的<strong>默认新生代收集器</strong>，主要就是因为它简单而高效（没有线程交互的开销）；</li>
</ul>
<h4 id="2-ParNew收集器（Serial收集器的多线程版本）"><a href="#2-ParNew收集器（Serial收集器的多线程版本）" class="headerlink" title="2.ParNew收集器（Serial收集器的多线程版本）"></a>2.ParNew收集器（Serial收集器的多线程版本）</h4><p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a84978969475?imageView2/0/w/1280/h/960/ignore-error/1" alt="ParNew收集器"></p>
<ul>
<li>其实就是Serial收集器的多线程版本；</li>
<li>ParNew收集器在单CPU环境中绝对不会有比Serial收集器更好的效果；</li>
<li>是许多运行在Server模式下虚拟机首选的新生代收集器，重要原因就是<strong>除了Serial收集器外，只有它能与CMS收集器配合工作</strong>；</li>
<li>并行（Parallel）：指多条垃圾收集线程并行工作，但此时用户线程仍处于等待状态；</li>
<li>并发（Concurrent）：指用户线程与垃圾收集线程同时执行，用户线程在继续执行而垃圾收集程序运行在另外一个CPU上；</li>
</ul>
<h4 id="3-Parallel-Scavenge收集器"><a href="#3-Parallel-Scavenge收集器" class="headerlink" title="3.Parallel Scavenge收集器"></a>3.Parallel Scavenge收集器</h4><blockquote>
<p>吞吐量=运行用户代码时间/(运行用户代码时间+垃圾收集时间)</p>
</blockquote>
<ul>
<li>新生代收集器，使用复制算法，并行的多线程收集器；</li>
<li>与<strong>CMS关注于尽可能缩短垃圾收集时用户线程停顿时间</strong>不同，<strong>PS的目标是达到一个可控制的吞吐量</strong>；</li>
<li>高吞吐量可以高效率利用CPU时间，适合在后台运算而不需要太多交互的任务；</li>
<li>-XX:MaxGCPauseMillis参数可以设置最大停顿时间，而停顿时间缩短是以牺牲吞吐量和新生代空间来换取的；</li>
<li>另外它还支持GC自适应的调节策略；</li>
</ul>
<h4 id="4-Serial-Old收集器"><a href="#4-Serial-Old收集器" class="headerlink" title="4.Serial Old收集器"></a>4.Serial Old收集器</h4><p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a8497cb58693?imageView2/0/w/1280/h/960/ignore-error/1" alt="Serial Old收集器"></p>
<ul>
<li>是Serial收集器的老年代版本，同样是单线程，使用标记-整理算法；</li>
<li>主要是给Client模式下的虚拟机使用的；</li>
<li>在Server模式下主要是给JDK 1.5及之前<strong>配合Parallel Scavenge使用或作为CMS收集器的后备预案</strong>；</li>
</ul>
<h4 id="5-Parallel-Old收集器"><a href="#5-Parallel-Old收集器" class="headerlink" title="5.Parallel Old收集器"></a>5.Parallel Old收集器</h4><p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a84999e5f1e9?imageView2/0/w/1280/h/960/ignore-error/1" alt="Parallel Old收集器"></p>
<ul>
<li>是Parallel Scavenge的老年代版本，使用多线程和标记-整理算法；</li>
</ul>
<h4 id="6-CMS收集器"><a href="#6-CMS收集器" class="headerlink" title="6.CMS收集器"></a>6.CMS收集器</h4><p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a849d2efb2e6?imageView2/0/w/1280/h/960/ignore-error/1" alt="CMS收集器"></p>
<ul>
<li><strong>是一种以获取最短回收停顿时间为目标的收集器</strong>，特别适合互联网站或者B/S的服务端；</li>
<li>它是基于标记-清除 算法实现的，主要包括4个步骤：<strong>初始标记</strong>（STW-stop the world，只是初始标记一下GC Roots能直接关联到的对象，速度很快）、<strong>并发标记</strong>（非STW，执行GC RootsTracing，耗时比较长）、<strong>重新标记</strong>（STW，修正并发标记期间因用户程序继续导致变动的那一部分对象标记）和<strong>并发清除</strong>（非STW，耗时较长）；</li>
<li>还有3个明显的缺点：<strong>CMS收集器对CPU非常敏感</strong>（占用部分线程及CPU资源，影响总吞吐量）、<strong>无法处理浮动垃圾</strong>（默认达到92%就触发垃圾回收）、<strong>大量内存碎片产生</strong>（可以通过参数启动压缩）；</li>
</ul>
<h4 id="7-G1收集器"><a href="#7-G1收集器" class="headerlink" title="7.G1收集器"></a>7.G1收集器</h4><p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a849a7b21b24?imageView2/0/w/1280/h/960/ignore-error/1" alt="G1收集器"></p>
<ul>
<li>一款面向服务端应用的垃圾收集器，后续会替换掉CMS垃圾收集器；</li>
<li>特点：<strong>并行与并发</strong>（充分利用多核多CPU缩短Stop-The-World时间）、<strong>分代收集</strong>（独立管理整个Java堆，但针对不同年龄的对象采取不同的策略）、<strong>空间整合</strong>（基于标记-整理）、<strong>可预测的停顿</strong>（将堆分为大小相等的独立区域，避免全区域的垃圾收集）；</li>
<li>关于Region：新生代和老年代不再物理隔离，只是部分Region的集合；G1跟踪各个Region垃圾堆积的价值大小，在后台维护一个优先列表，根据允许的收集时间优先回收价值最大的Region；Region之间的对象引用以及其他收集器中的新生代与老年代之间的对象引用，采用Remembered Set来避免全堆扫描；</li>
<li>分为几个步骤：<strong>1.初始标记</strong>（标记一下GC Roots能直接关联的对象并修改TAMS值，需要STW但耗时很短）、<strong>2.并发标记</strong>（从GC Root从堆中对象进行可达性分析找存活的对象，耗时较长但可以与用户线程并发执行）、<strong>3.最终标记</strong>（为了修正并发标记期间产生变动的那一部分标记记录，这一期间的变化记录在Remembered Set Log里，然后合并到Remembered Set里，该阶段需要STW但是可并行执行）、<strong>4.筛选回收</strong>（对各个Region回收价值排序，根据用户期望的GC停顿时间制定回收计划来回收）；</li>
<li><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a8499ea082f5?imageView2/0/w/1280/h/960/ignore-error/1" alt="img"></li>
</ul>
<h3 id="理解GC日志"><a href="#理解GC日志" class="headerlink" title="理解GC日志"></a>理解GC日志</h3><p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a8c58a032b54?imageView2/0/w/1280/h/960/ignore-error/1" alt="img"></p>
<ul>
<li>最前面的数字代表GC发生的时间（虚拟机启动以后的秒杀）；</li>
<li>“[GC”和“[Full GC”说明停顿类型，有Full代表的是Stop-The-World的；</li>
<li>“[DefNew”、“[Tenured”和“[Perm”表示GC发生的区域；</li>
<li>方括号内部的“3324K -&gt; 152K(3712K)” 含义是 “GC前该内存已使用容量 -&gt; GC后该内存区域已使用容量(该区域总容量)”;</li>
<li>方括号之外的“3324K -&gt; 152K(11904)” 含义是 “GC前Java堆已使用容量 -&gt; GC后Java堆已使用容量(Java堆总容量)”;</li>
<li>再往后“0.0025925 secs”表示该内存区域GC所占用的时间；</li>
</ul>
<h3 id="内存分配与回收策略"><a href="#内存分配与回收策略" class="headerlink" title="内存分配与回收策略"></a>内存分配与回收策略</h3><ul>
<li>对象优先在新生代分配</li>
<li>大对象直接进入老年代</li>
<li>长期存活的对象将进入老年代</li>
<li>动态对象年龄判断：如果在Survivor空间中相同年龄所有对象大小总和大于Survivor空间的一半，大于或等于该年龄的对象直接进入老年代；</li>
<li>空间分配担保：发生Minor GC前，虚拟机会先检查老年代最大可用连续空间是否大于新生代所有对象总空间，如果不成立，虚拟机会查看HandlePromotionFailure设置值是否允许担保失败，如果允许继续检查老年代最大可用的连续空间是否大于历次晋升到老年代的平均大小，如果大于会尝试进行一次Minor GC；如果小于或者不允许冒险，会进行一次Full GC；</li>
</ul>
<h2 id="虚拟机类加载机制"><a href="#虚拟机类加载机制" class="headerlink" title="虚拟机类加载机制"></a>虚拟机类加载机制</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><ul>
<li>虚拟机把描述类的数据从Class文件加载到内存，并对数据进行校验、转换解析和初始化，最终形成可以被虚拟机直接使用的Java类型，这就是虚拟机的类加载机制。</li>
<li>在Java语言里面，类型的加载、连接和初始化过程都是在程序运行期间完成，这虽然增量一些性能开销，但是会为Java应用程序提供高度的灵活性。</li>
</ul>
<h3 id="类加载的时机"><a href="#类加载的时机" class="headerlink" title="类加载的时机"></a>类加载的时机</h3><ul>
<li>类的整个生命周期：加载、验证、准备、解析、初始化、使用和卸载；其中验证、准备和解析统称为连接；</li>
<li>虚拟机规范没有强制约束类加载的时机，但严格规定了有且只有5种情况必须立即对类进行初始化：遇到new、getstatic、putstatic和invokestatic指令；对类进行反射调用时如果类没有进行过初始化；初始化时发现父类还没有进行初始化；虚拟机启动指定的主类；动态语言中MethodHandle实例最后解析结果REF_getStatic等的方法句柄对应的类没有初始化时；</li>
</ul>
<h3 id="类加载的过程"><a href="#类加载的过程" class="headerlink" title="类加载的过程"></a>类加载的过程</h3><h4 id="1-加载"><a href="#1-加载" class="headerlink" title="1.加载"></a>1.加载</h4><ul>
<li>通过一个类的全限定名来获取定义此类的二进制字节流；</li>
<li>将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构；</li>
<li>在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口；</li>
</ul>
<h4 id="2-验证"><a href="#2-验证" class="headerlink" title="2.验证"></a>2.验证</h4><ul>
<li>验证是连接阶段的第一步，其目的是确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全；</li>
<li>验证阶段是非常重要的，这个阶段是否严谨决定了Java虚拟机是否能承受恶意代码的攻击；</li>
<li>校验动作：文件格式验证（基于二进制字节流）、元数据验证（对类的元数据语义分析）、字节码验证（对方法体语义分析）、符号引用验证（对类自身以外的信息进行匹配性校验）；</li>
</ul>
<h4 id="3-准备"><a href="#3-准备" class="headerlink" title="3.准备"></a>3.准备</h4><ul>
<li>正式为变量分配内存并设置类变量初始值的阶段，这些变量所使用的内存都将在这个方法区中进行分配；</li>
<li>需要强调两点：这时候内存分配的仅包括类变量，而不包括类实例变量；这里所说的初始化通常情况下是数据类型的零值，真正的赋值是在初始化阶段，如果是static final的则是直接赋值；</li>
</ul>
<h4 id="4-解析"><a href="#4-解析" class="headerlink" title="4.解析"></a>4.解析</h4><ul>
<li>解析阶段是虚拟机将常量池内的符号引用（如<code>CONSTANT_Class_info</code>、<code>CONSTANT_Fieldref_info</code>、<code>CONSTANT_Methodref_info</code>等7种）替换为直接引用的过程；</li>
<li>符号引用可以是任何形式的字面量，与虚拟机实现的内存布局无关，引用的目标并不一定已经加载到内存中；而直接引用是直接指向目标的指针、相对偏移量或是一个能间接定位到目标的句柄，它和虚拟机实现的内存布局相关，引用的目标必定以及在内存中存在；</li>
<li>对同一个符号引用进行多次解析请求是很常见的事情，虚拟机实现可以对第一次解析的结果进行缓存；</li>
</ul>
<h4 id="5-初始化"><a href="#5-初始化" class="headerlink" title="5.初始化"></a>5.初始化</h4><ul>
<li>是类加载过程的最后一步，真正开始执行类中定义的Java程序代码（或者说是字节码）；</li>
<li>初始化阶段是执行类构造器方法的过程，该方法是由编译器自动收集类中的所有类变量的赋值动作和静态语句块中的语句合并产生的；</li>
<li>方法与类的构造函数（或者说是实例构造器方法）不同，它不需要显式地调用父类构造器，虚拟机会保证在子类的方法执行之前，父类的方法已执行完毕；</li>
<li>执行接口的方法不需要先执行父接口的方法，只有当父接口中定义的变量使用时父接口才会初始化，接口的实现类在初始化时也一样不会执行接口的方法；</li>
<li>方法初始化是加锁阻塞等待的，应当避免在方法中有耗时很长的操作；</li>
</ul>
<h3 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h3><ul>
<li>虚拟机设计团队把类加载阶段的“通过一个类的全限定名来获取描述此类的二进制字节流”这个动作放到虚拟机外部去实现，实现这个动作的代码模块称为类加载器；</li>
<li>这是Java语言的一项创新，也是Java语言流行的重要原因，在类层次划分、OSGI、热部署、代码加密等领域大放异彩</li>
</ul>
<h4 id="类与类加载器"><a href="#类与类加载器" class="headerlink" title="类与类加载器"></a>类与类加载器</h4><ul>
<li>对于任意一个类，都需要由加载它的类加载器和这个类本身一同确立其在Java虚拟机的唯一性，每一个类加载器都拥有一个独立的类名称空间；</li>
<li>比较两个类是否相等（如Class对象的equals方法、isAssignableFrom方法、isInstance方法），只有在这两个类是由同一个类加载器加载的前提下才有意义；</li>
</ul>
<h4 id="双亲委派模型"><a href="#双亲委派模型" class="headerlink" title="双亲委派模型"></a>双亲委派模型</h4><blockquote>
<p>关于双亲委派模型，这篇文章写得简单易懂:<a href="http://www.jianshu.com/p/acc7595f1b9d" target="_blank" rel="external">http://www.jianshu.com/p/acc7595f1b9d</a></p>
</blockquote>
<p><img src="https://user-gold-cdn.xitu.io/2017/12/12/1604a8c5de316d00?imageView2/0/w/1280/h/960/ignore-error/1" alt="image.png"></p>
<ul>
<li>三种系统提供的类加载器：启动类加载器（Bootstrap ClassLoader）、扩展类加载器（Extension ClassLoader）、应用程序类加载器（Application ClassLoader）；</li>
<li>双亲委派模型要求除了顶层的启动类加载器外，其他的类加载器都应当有自己的父类加载器，这里一般不会以继承的关系来实现，而是使用组合的关系来复用父加载器的代码；</li>
<li>其工作过程是：如果一个类加载器收到了类加载的请求，它首先不会自己去尝试加载这个类，而是把这个请求委派给父类加载器去完成，只有父类加载器反馈自己无法完成这个加载请求时（它的搜索范围中没有找到所需的类），子加载器才会尝试自己去加载；</li>
<li>这样的好处是Java类随着它的类加载器具备了一种带有优先级的层次关系，对保证Java程序的稳定运作很重要；</li>
<li>实现双亲委派的代码都集中在java.lang.ClassLoader的loadClass方法中，逻辑清晰易懂；</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/Horizon.github.io/page/2/">2</a><a class="extend next" rel="next" href="/Horizon.github.io/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Horizon</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/Horizon.github.io/archives/">
              
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/Horizon.github.io/tags/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Horizon</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/Horizon.github.io/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/Horizon.github.io/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/Horizon.github.io/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/Horizon.github.io/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/Horizon.github.io/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/Horizon.github.io/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/Horizon.github.io/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/Horizon.github.io/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/Horizon.github.io/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
